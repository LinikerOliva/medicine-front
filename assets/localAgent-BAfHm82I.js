import{a as z}from"./index-BtEMbjXW.js";const $=()=>{const n="http://localhost:18080".trim();return n?n.endsWith("/")?n.slice(0,-1):n:"http://localhost:18080"},E=(n,e="documento_assinado.pdf")=>{if(!n)return e;const t=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(n);try{return decodeURIComponent((t==null?void 0:t[1])||(t==null?void 0:t[2])||e)}catch{return(t==null?void 0:t[1])||(t==null?void 0:t[2])||e}};async function k(n){try{return await n.json()}catch{return null}}const R={async detectTokens(){const n=$();try{const e=await fetch(`${n}/local-sign`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({action:"detect"}),credentials:"omit",mode:"cors"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await k(e);return Array.isArray(t==null?void 0:t.tokens)?{status:"ok",tokens:t.tokens}:Array.isArray(t==null?void 0:t.certs)?{status:"ok",tokens:t.certs}:{status:"ok",tokens:[]}}catch{for(const e of["/tokens","/certs","/local/tokens"])try{const t=await fetch(`${n}${e}`,{headers:{Accept:"application/json"},credentials:"omit",mode:"cors"});if(!t.ok)continue;const a=await k(t);if(Array.isArray(a))return{status:"ok",tokens:a};if(Array.isArray(a==null?void 0:a.tokens))return{status:"ok",tokens:a.tokens};if(Array.isArray(a==null?void 0:a.certs))return{status:"ok",tokens:a.certs}}catch{}return{status:"error",tokens:[]}}},async signHash({document_hash:n,format:e="PAdES",prefer_certificate:t=null,pin:a}){const d=$(),p={action:"sign",document_hash:n,format:e,prefer_certificate:t};a&&String(a).length>0&&(p.pin=String(a));const i=await fetch(`${d}/local-sign`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(p),credentials:"omit",mode:"cors"}),u=await k(i);return i.ok?u||{status:"error",code:"INVALID_RESPONSE",message:"Resposta inválida do agente local."}:u||{status:"error",code:`HTTP_${i.status}`,message:"Falha ao assinar via agente local."}},async finalizeWithBackend({receitaId:n,pdfFile:e,assinatura:t,certificado:a,thumbprint:d,cert_subject:p,timestamp:i,hash_pre:u}){var A,f,g,T,_;const s=new FormData;e&&(s.append("file",e),s.append("documento",e),s.append("pdf",e)),n&&(s.append("receita",n),s.append("receita_id",n),s.append("id",n)),t&&s.append("assinatura",t),a&&s.append("certificado",a),d&&s.append("thumbprint",d),p&&s.append("cert_subject",p),i&&s.append("timestamp",i),u&&s.append("hash_pre",u),s.append("hash_alg","SHA-256"),s.append("assinatura_externa","true");const o=[],w="".trim();w&&o.push(w);const y="/receitas/",m=y.endsWith("/")?y:`${y}/`;o.push("/api/assinatura/finalizar/"),o.push("/assinatura/finalizar/"),o.push("/documentos/assinar_externo/"),o.push("/assinatura/externa/finalizar/"),o.push(`${m}finalizar_assinatura_externa/`),n&&o.push(`${m}${n}/finalizar_assinatura_externa/`);let l=null;for(const h of o){if(!h)continue;const S=h.endsWith("/")?h:`${h}/`;try{const r=await z.post(S,s,{responseType:"blob"}),c=((A=r.headers)==null?void 0:A["content-disposition"])||((g=(f=r.headers)==null?void 0:f.get)==null?void 0:g.call(f,"content-disposition")),b=E(c),x=new Blob([r.data],{type:((T=r.headers)==null?void 0:T["content-type"])||"application/pdf"});return{filename:b,blob:x}}catch(r){const c=(_=r==null?void 0:r.response)==null?void 0:_.status;if(c===404||c===405){l=r;continue}if(c&&[400,422].includes(c))throw r;l=r}}throw l||new Error("Nenhum endpoint compatível para finalizar assinatura externa.")}};export{R as default,R as localAgent};
