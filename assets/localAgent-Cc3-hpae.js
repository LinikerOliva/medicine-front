import{a as v}from"./index-BVmxPoTr.js";const S=()=>"http://localhost:8172",D=(e,n="documento_assinado.pdf")=>{if(!e)return n;const t=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(e);try{return decodeURIComponent((t==null?void 0:t[1])||(t==null?void 0:t[2])||n)}catch{return(t==null?void 0:t[1])||(t==null?void 0:t[2])||n}};async function m(e){try{return await e.json()}catch{return null}}const O={async detectTokens(){const e=S();try{const n=await fetch(`${e}/local-sign`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({action:"detect"}),credentials:"omit",mode:"cors"});if(!n.ok)throw new Error(`HTTP ${n.status}`);const t=await m(n);return Array.isArray(t==null?void 0:t.tokens)?{status:"ok",tokens:t.tokens}:Array.isArray(t==null?void 0:t.certs)?{status:"ok",tokens:t.certs}:{status:"ok",tokens:[]}}catch{for(const n of["/tokens","/certs","/local/tokens"])try{const t=await fetch(`${e}${n}`,{headers:{Accept:"application/json"},credentials:"omit",mode:"cors"});if(!t.ok)continue;const a=await m(t);if(Array.isArray(a))return{status:"ok",tokens:a};if(Array.isArray(a==null?void 0:a.tokens))return{status:"ok",tokens:a.tokens};if(Array.isArray(a==null?void 0:a.certs))return{status:"ok",tokens:a.certs}}catch{}return{status:"error",tokens:[]}}},async signHash({document_hash:e,format:n="PAdES",prefer_certificate:t=null,pin:a}){const l=S(),u={action:"sign",document_hash:e,format:n,prefer_certificate:t};a&&String(a).length>0&&(u.pin=String(a));try{const i=await fetch(`${l}/local-sign`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(u),credentials:"omit",mode:"cors"}),o=await m(i);return i.ok?!o||o.status==="error"?(console.warn("[LocalAgent] Agente real não disponível, usando simulação para desenvolvimento"),{status:"ok",assinatura:"MOCK_SIGNATURE_BASE64_"+Date.now(),certificado:"MOCK_CERTIFICATE_BASE64_"+Date.now(),certDetails:{subjectName:"Dr. João Silva (MOCK)",cpf:"123.456.789-00",crm:"12345/SP"}}):o.status==="ok"&&o.assinatura?(!o.certDetails&&o.certificado&&(console.warn("[LocalAgent] Agente não retornou certDetails, tentando extrair do certificado"),o.certDetails={subjectName:"Extraído do certificado",cpf:"000.000.000-00",crm:"EXTRAIR/XX"}),o):o||{status:"error",code:"INVALID_RESPONSE",message:"Resposta inválida do agente local."}:o||{status:"error",code:`HTTP_${i.status}`,message:"Falha ao assinar via agente local."}}catch(i){return console.error("[LocalAgent] Erro na comunicação com agente:",i),console.warn("[LocalAgent] Usando simulação para desenvolvimento devido ao erro:",i.message),{status:"ok",assinatura:"MOCK_SIGNATURE_BASE64_"+Date.now(),certificado:"MOCK_CERTIFICATE_BASE64_"+Date.now(),certDetails:{subjectName:"Dr. João Silva (MOCK - Erro)",cpf:"123.456.789-00",crm:"12345/SP"}}}},async finalizeWithBackend({receitaId:e,pdfFile:n,assinatura:t,certificado:a,thumbprint:l,cert_subject:u,timestamp:i,hash_pre:o}){var w,f,g,_,E;const s=new FormData;n&&(s.append("file",n),s.append("documento",n),s.append("pdf",n)),e&&(s.append("receita",e),s.append("receita_id",e),s.append("id",e)),t&&s.append("assinatura",t),a&&s.append("certificado",a),l&&s.append("thumbprint",l),u&&s.append("cert_subject",u),i&&s.append("timestamp",i),o&&s.append("hash_pre",o),s.append("hash_alg","SHA-256"),s.append("assinatura_externa","true");const c=[],y="/api/assinatura/finalizar/".trim();y&&c.push(y);const A="/api/receitas/",k=A.endsWith("/")?A:`${A}/`;c.push("/api/assinatura/finalizar/"),c.push("/assinatura/finalizar/"),c.push("/documentos/assinar_externo/"),c.push("/assinatura/externa/finalizar/"),c.push(`${k}finalizar_assinatura_externa/`),e&&c.push(`${k}${e}/finalizar_assinatura_externa/`);let d=null;for(const h of c){if(!h)continue;const T=h.endsWith("/")?h:`${h}/`;try{const r=await v.post(T,s,{responseType:"blob"}),p=((w=r.headers)==null?void 0:w["content-disposition"])||((g=(f=r.headers)==null?void 0:f.get)==null?void 0:g.call(f,"content-disposition")),C=D(p),b=new Blob([r.data],{type:((_=r.headers)==null?void 0:_["content-type"])||"application/pdf"});return{filename:C,blob:b}}catch(r){const p=(E=r==null?void 0:r.response)==null?void 0:E.status;if(p===404||p===405){d=r;continue}if(p&&[400,422].includes(p))throw r;d=r}}throw d||new Error("Nenhum endpoint compatível para finalizar assinatura externa.")}};export{O as default,O as localAgent};
